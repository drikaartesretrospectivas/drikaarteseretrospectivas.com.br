<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Lucca 2 Anos</title>
    <style>
        :root { --accent: #25D366; --record: #ff0000; --boom: #e1306c; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; width: 100vw; height: 100dvh; font-family: sans-serif; }
        
        .stage { position: relative; width: 100%; height: 100%; overflow: hidden; background: #000; touch-action: none; }
        #camera { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #molduraImagePreview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; pointer-events: none; z-index: 10; display: none; }
        
        /* UI LATERAL DIREITA */
        .ui-layer { position: absolute; inset: 0; z-index: 50; pointer-events: none; display: none; }
        .side-bar { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 20px; align-items: center; pointer-events: auto; }
        .btn-side { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #fff; background: rgba(0,0,0,0.5); font-size: 24px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-boom { border-color: var(--boom); color: var(--boom); font-weight: bold; }

        /* LOADING BOOMERANG */
        #boomLoading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); padding: 20px; border-radius: 15px; border: 2px solid var(--boom); z-index: 200; display: none; }

        /* RESULTADO */
        #resultUI { position: absolute; inset: 0; z-index: 150; display: none; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 50px; background: #000; }
        #videoPreview { width: 100%; height: 100%; object-fit: contain; }
        .actions-box { position: absolute; bottom: 40px; display: flex; flex-direction: column; gap: 15px; width: 85%; }
        .btn-res { padding: 20px; border-radius: 15px; border: none; font-weight: bold; font-size: 18px; color: #fff; text-align: center; text-decoration: none; cursor: pointer; }

        /* CAPA */
        #startScreen { position: absolute; inset: 0; background: #000 url('capajpg.jpg') center/cover no-repeat; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        #startBtn { padding: 25px 55px; font-size: 22px; font-weight: bold; background: #FF5722; color: #fff; border: none; border-radius: 50px; }
    </style>
</head>
<body>

<div class="stage">
    <video id="camera" autoplay playsinline muted></video>
    <img id="molduraImagePreview" src="" />
    <div id="boomLoading">ðŸš€ Criando Boomerang...</div>

    <div class="ui-layer" id="cameraUI">
        <div class="side-bar">
            <button class="btn-side" onclick="takePhoto()">ðŸ“·</button>
            <button class="btn-side btn-boom" onclick="startBoomerang()">âˆž</button>
            <button class="btn-side" onclick="location.reload()">ðŸ”„</button>
        </div>
    </div>

    <div id="resultUI">
        <video id="videoPreview" playsinline loop muted autoplay></video>
        <div class="actions-box">
            <a id="downloadBtn" class="btn-res" style="background:var(--accent);">ðŸ“¥ BAIXAR AGORA</a>
            <button class="btn-res" style="background:#444;" onclick="location.reload()">ðŸ”„ VOLTAR</button>
        </div>
    </div>

    <div id="startScreen"><button id="startBtn" onclick="initCamera()">INICIAR</button></div>
</div>

<canvas id="tempCanvas" style="display:none;"></canvas>

<script>
let stream, boomFrames = [];
const video = document.getElementById('camera');
const moldura = document.getElementById('molduraImagePreview');
const tempCanvas = document.getElementById('tempCanvas');
const tCtx = tempCanvas.getContext('2d');

async function initCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        video.srcObject = stream;
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('cameraUI').style.display = 'block';
        moldura.src = 'moldura1.png';
        moldura.style.display = 'block';
    } catch (e) { alert("CÃ¢mara bloqueada ou sem HTTPS."); }
}

function takePhoto() {
    tempCanvas.width = 1080; tempCanvas.height = 1920;
    tCtx.drawImage(video, 0, 0, 1080, 1920);
    tCtx.drawImage(moldura, 0, 0, 1080, 1920);
    showResult(tempCanvas.toDataURL('image/png'), 'image');
}

// LÃ“GICA DO BOOMERANG (PING-PONG)
async function startBoomerang() {
    document.getElementById('boomLoading').style.display = 'block';
    boomFrames = [];
    tempCanvas.width = 480; // ResoluÃ§Ã£o menor para processar rÃ¡pido
    tempCanvas.height = 854;

    // Captura 20 frames (aprox 1.2 segundos)
    for (let i = 0; i < 20; i++) {
        tCtx.drawImage(video, 0, 0, 480, 854);
        tCtx.drawImage(moldura, 0, 0, 480, 854);
        boomFrames.push(tempCanvas.toDataURL('image/webp', 0.7));
        await new Promise(r => setTimeout(r, 60));
    }

    // Criar o efeito ida e volta
    const fullSequence = [...boomFrames, ...[...boomFrames].reverse()];
    
    // Converter sequÃªncia para VÃ­deo (Blob)
    const streamCanvas = document.createElement('canvas');
    streamCanvas.width = 480; streamCanvas.height = 854;
    const sCtx = streamCanvas.getContext('2d');
    const streamRec = streamCanvas.captureStream(15);
    const recorder = new MediaRecorder(streamRec, { mimeType: 'video/webm' });
    const chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
        const videoBlob = new Blob(chunks, { type: 'video/webm' });
        showResult(URL.createObjectURL(videoBlob), 'video');
        document.getElementById('boomLoading').style.display = 'none';
    };

    recorder.start();
    let frameIdx = 0;
    const interval = setInterval(() => {
        if (frameIdx >= fullSequence.length) {
            clearInterval(interval);
            recorder.stop();
        } else {
            const img = new Image();
            img.src = fullSequence[frameIdx];
            img.onload = () => sCtx.drawImage(img, 0, 0);
            frameIdx++;
        }
    }, 60);
}

function showResult(url, type) {
    document.getElementById('cameraUI').style.display = 'none';
    document.getElementById('resultUI').style.display = 'flex';
    const videoPrev = document.getElementById('videoPreview');
    
    if(type === 'video') {
        videoPrev.src = url;
    } else {
        // Se for foto, mostra como imagem estÃ¡tica no preview
        videoPrev.poster = url;
    }
    
    const dl = document.getElementById('downloadBtn');
    dl.href = url;
    dl.download = `lucca2anos_${Date.now()}.${type === 'image' ? 'png' : 'webm'}`;
}
</script>
</body>
</html>
